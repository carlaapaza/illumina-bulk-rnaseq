---
title: "Pig brain"
author: "Carla Apaza"
date: "2025-10-17"
output: html_document
---

```{r}
library(tidyverse)
library(tximport)
library(tibble)
library(rtracklayer)      
library(GenomicFeatures)
library(GenomicRanges)
library(DESeq2)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(scales)
library(fgsea)
library(AnnotationDbi)
library(org.Ss.eg.db)
library(GO.db)
library(openxlsx)
library(ggridges)
library(ComplexHeatmap)
library(circlize)
library(grid)
library(viridis)
library(readxl)
```


# step 1.1 retrieve files
```{r}
base_dir <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/quant"
samples <- list.dirs(base_dir, recursive = FALSE, full.names = FALSE)
files <- file.path(base_dir, samples, "quant.sf")
names(files) <- samples
all(file.exists(files))

```

# step 1.2 make tx2gene
```{r}
gtf_path <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/references/genomic.gtf"
gtf <- rtracklayer::import(gtf_path)  # GRanges

## Extra: complete columns if missing
mc <- as.data.frame(mcols(gtf))
if (!"gene_id" %in% names(mc)) mc$gene_id <- NA_character_
if (!"transcript_id" %in% names(mc)) mc$transcript_id <- NA_character_
if (!"gene" %in% names(mc)) mc$gene <- NA_character_
if (!"gene_biotype" %in% names(mc)) mc$gene_biotype <- NA_character_
if (!"product" %in% names(mc)) mc$product <- NA_character_
if (!"db_xref" %in% names(mc)) mc$db_xref <- NA_character_

mcols(gtf) <- mc

## tx2gene (transcript_id -> gene_id)
## NCBI uses "transcript" (sometimes mRNA/lnc_RNA). filter feature type transcript
tx_rows <- gtf$type %in% c("transcript", "mRNA", "lnc_RNA", "miRNA", "rRNA", "tRNA", "snRNA", "snoRNA")
extract_geneid <- function(x) {
  out <- stringr::str_match(x, "GeneID:([0-9]+)")[,2]
  ifelse(is.na(out), NA_character_, out)
}

tx_tbl <- as.data.frame(mcols(gtf[tx_rows])) %>%
  transmute(
    transcript_id = na_if(transcript_id, ""),
    gene_id       = na_if(gene_id, ""),
    gene_symbol   = na_if(gene, ""),
    geneID        = extract_geneid(db_xref) 
  ) %>%
  filter(!is.na(transcript_id), !is.na(gene_id)) %>%
  distinct()

tx2gene <- tx_tbl %>% dplyr::select(transcript_id, gene_id)

## txdb
# txdb <- GenomicFeatures::makeTxDbFromGFF(gtf_path, format = "gtf")
```

```{r}
mc_unique <- mc %>%
  group_by(gene_id) %>%
  summarise(description = dplyr::first(na.omit(product)), .groups = "drop")

na_count <- sum(is.na(mc_unique$description))
na_count
```


# step 1.3 import quant from tximport
```{r}
txi <- tximport(files,
                type = "salmon",
                tx2gene = tx2gene,
                countsFromAbundance = "lengthScaledTPM")

write.xlsx(txi$counts, file = "./results/0_raw_counts_matrix.xlsx", rowNames = TRUE)
```

# step 1.4 prep metadata
```{r}
metadata <- read_xlsx("/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/references/NCC_metadata.xlsx")

metadata_filtered <- metadata %>%
  filter(Animal == "Pig") %>%
  dplyr::select(`Fastq ID`, Sample_ID, Group, Capsule, Location) %>%
  rename(
    file_id  = `Fastq ID`,
    sample_id = Sample_ID,
    group     = Group,
    capsule   = Capsule,
    location  = Location
  ) %>%
  mutate(
    classification = case_when(
      group == "Infected treated (120h)" & capsule == "Blue" ~ "A",
      group == "Infected untreated" & (capsule %in% c("Clear", "Clear (control)")) ~ "B",
      group == "Uninfected untreated" & capsule == "Clear" ~ "C",
      group == "Infected treated (120h)" & capsule == "Clear (control)" ~ "E",
      group == "Infected untreated" & capsule == "Blue" ~ "F",
      TRUE ~ NA_character_
    )
  )

```

# step 2 exclude samples + differential expression analysis

```{r}
excluded <- c("22122XR-01-02","22122XR-01-05","22122XR-01-08",
              "22122XR-01-14","22122XR-01-16","22122XR-01-18")

meta <- metadata_filtered %>%
  filter(!(file_id %in% excluded)) %>%
  filter(file_id %in% colnames(txi$counts)) %>%
  arrange(match(file_id, colnames(txi$counts)))

keep <- colnames(txi$counts) %in% meta$file_id
txi_sub <- txi
txi_sub$counts     <- txi$counts[, keep, drop = FALSE]
txi_sub$abundance  <- txi$abundance[, keep, drop = FALSE]
txi_sub$length     <- txi$length[, keep, drop = FALSE]

dds <- DESeqDataSetFromTximport(txi_sub, 
                                colData = meta, 
                                design = ~ classification)

dds <- DESeq(dds)
```

# step 2.1 pca of samples

```{r}
vsd <- vst(dds, blind = FALSE)
gene_var <- apply(assay(vsd), 1, var)
threshold <- quantile(gene_var, 0.95)
high_var_genes <- names(gene_var[gene_var >= threshold])
vsd_high <- vsd[high_var_genes, ]

# Extract PCA data
pcaData <- plotPCA(vsd, intgroup = "classification", returnData = TRUE, ntop = nrow(vsd_high))
percentVar <- round(100 * attr(pcaData, "percentVar"))

# Recode classification labels
pcaData <- pcaData %>%
  mutate(Group = recode(classification,
                        "A" = "Infected treated",
                        "B" = "Infected untreated",
                        "C" = "Uninfected untreated"))

# Define colors for groups
my_colors <- c(
  "Infected treated" = "#A13043",
  "Infected untreated" = "#E5985F",
  "Uninfected untreated" = "#E9E68F"
)

# PCA plot
ggplot(pcaData, aes(PC1, PC2, color = Group, label = name)) +
  geom_point(size = 4) +
  ggrepel::geom_text_repel(size = 3, show.legend = FALSE, max.overlaps = Inf) +
  xlab(paste0("PC1 (", percentVar[1], "%)")) +
  ylab(paste0("PC2 (", percentVar[2], "%)")) +
  scale_color_manual(values = my_colors, name = "Group") +
  theme_bw(base_size = 14) +
  theme(
    plot.title = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    legend.position = "right",
    panel.grid = element_blank(),
  )
```


# step 2.2 deg and volcano plots

## A (treatment) vs B (no treatment)

```{r}
res_A_vs_B <- results(dds, contrast = c("classification", "A", "B"), alpha = 0.05)
res_A_vs_B <- res_A_vs_B[order(res_A_vs_B$padj), ]
summary(res_A_vs_B)
res_A_vs_B_df <- as.data.frame(res_A_vs_B)
res_A_vs_B_df <- as.data.frame(res_A_vs_B) %>%
  tibble::rownames_to_column("gene_id")
res_A_vs_B_df <- res_A_vs_B_df %>%
  left_join(mc_unique, by = "gene_id")
res_A_vs_B_df <- res_A_vs_B_df %>%
  mutate(
    regulation = case_when(
      padj < 0.05 & log2FoldChange >  1  ~ "Up-regulated",
      padj < 0.05 & log2FoldChange < -1  ~ "Down-regulated",
      TRUE                               ~ "Not significant"
    )
  )
res_A_vs_B_df <- res_A_vs_B_df %>%
  relocate(description, .after = last_col()) %>%
  relocate(regulation, .after = description)

write.xlsx(res_A_vs_B_df, 
          file = "./results/1_deg/DEG_A_vs_B.xlsx")
```

```{r}
alpha   <- 0.05
lfc_thr <- 1

res_df <- as.data.frame(res_A_vs_B_df) %>%
  mutate(
    padj = ifelse(is.na(padj), 1, padj),
    neglog10padj = -log10(padj),
    log2FC = log2FoldChange,
    regulation = case_when(
      padj <= alpha & log2FC >=  lfc_thr ~ "Up-regulated",
      padj <= alpha & log2FC <= -lfc_thr ~ "Down-regulated",
      TRUE                               ~ "Not significant"
    )
  )


palette_volcano <- c(
  "Down-regulated" = "#22577a",
  "Not significant"            = "#B0B0B0",
  "Up-regulated"   = "#8b1e3f"
)

p_volcano <- ggplot(res_df, aes(x = log2FC, y = neglog10padj, color = regulation)) +
  geom_point(size = 3, alpha = 0.75) +
  geom_hline(yintercept = -log10(alpha), linewidth = 0.5, linetype = "dashed") +
  geom_vline(xintercept = c(-lfc_thr, lfc_thr), linewidth = 0.5, linetype = "dashed") +
  scale_color_manual(values = palette_volcano, name = "Regulation") +
  labs(
    x = "log2(FoldChange)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    legend.position = "right",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
p_volcano
```


```{r}
# Parameters
alpha        <- 0.05
lfc_thr      <- 1
gene_col     <- "gene_id"  # ajusta al nombre de tu columna de sÃ­mbolos/IDs si la tienes

dds$classification <- relevel(dds$classification, ref = "B")
dds <- DESeq(dds)
resultsNames(dds)
coef_name <- "classification_A_vs_B"
res_raw <- results(dds, name = coef_name, alpha = alpha)

# Shrunken LFCs
res_shrunk <- lfcShrink(dds, coef = coef_name, res = res_raw, type = "apeglm")

# keep p-values/padj wo shrink (res_raw) and replace log2FC for shrunken one
res_df <- as.data.frame(res_raw) %>%
  mutate(
    padj      = ifelse(is.na(padj), 1, padj),
    neglog10p = -log10(padj),
    log2FC_sh = as.numeric(res_shrunk$log2FoldChange)
  )

if (!gene_col %in% colnames(res_df)) {
  res_df[[gene_col]] <- rownames(res_df)
}

# classify using padj (raw) y |log2FC_sh|:
res_df <- res_df %>%
  mutate(
    regulation = case_when(
      padj <= alpha & log2FC_sh >=  lfc_thr ~ "Up-regulated",
      padj <= alpha & log2FC_sh <= -lfc_thr ~ "Down-regulated",
      TRUE                                  ~ "Not significant"
    )
  )

pal_fill <- c(
  "Down-regulated" = "#22577a",
  "Not significant"            = "#B0B0B0",
  "Up-regulated"   = "#8b1e3f"
)

# labels
label_df <- res_df %>%
  filter(regulation != "Not significant") %>%
  arrange(padj, desc(abs(log2FC_sh))) %>%
  filter(!is.na(.data[[gene_col]]))

# volcano plot
p_volcano <- ggplot(res_df, aes(x = log2FC_sh, y = neglog10p)) +
  geom_point(
    aes(color = regulation),
    shape = 16, size = 2.5, alpha = 0.75
  ) +
  geom_hline(yintercept = -log10(alpha), linewidth = 0.4, linetype = "dashed") +
  geom_vline(xintercept = c(-lfc_thr, lfc_thr), linewidth = 0.4, linetype = "dashed") +
  scale_color_manual(values = pal_fill, name = "Regulation") +
  labs(
    x = expression(paste("shrunken ", log[2], "(FoldChange)")),
    y = expression(paste(-log[10], "(p-adjusted)"))
  ) +
  theme_bw(base_size = 12) +
  theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.position = "right",
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    axis.ticks.length = unit(2.2, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )

# p_volcano <- p_volcano +
#   ggrepel::geom_text_repel(
#     data = label_df,
#     aes(
#       label = .data[[gene_col]],
#       color = regulation
#     ),
#     size = 3.5,
#     max.overlaps = 30,
#     box.padding = 0.25,
#     point.padding = 0.25,
#     min.segment.length = 0,
#     segment.size = 0.25,
#     seed = 123,
#     show.legend = FALSE
#   )

p_volcano

outfile_base <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/results/1_deg/figures/VP_A_vs_B_lfcshrink"

ggsave(
  filename = paste0(outfile_base, ".png"),
  plot = p_volcano,
  width = 8, height = 6, units = "in",
  dpi = 600,
  bg = "white"
)

ggsave(
  filename = paste0(outfile_base, ".svg"),
  plot = p_volcano,
  width = 8, height = 6, units = "in",
  device = "svg", 
  bg = "transparent"
)
```


## B (infected) vs C (uninfected)

```{r}
res_B_vs_C <- results(dds, contrast = c("classification", "B", "C"), alpha = 0.05)
res_B_vs_C <- res_B_vs_C[order(res_B_vs_C$padj), ]
summary(res_B_vs_C)
res_B_vs_C_df <- as.data.frame(res_B_vs_C)
res_B_vs_C_df <- as.data.frame(res_B_vs_C_df) %>%
  tibble::rownames_to_column("gene_id")
res_B_vs_C_df <- res_B_vs_C_df %>%
  left_join(mc_unique, by = "gene_id")
res_B_vs_C_df <- res_B_vs_C_df %>%
  mutate(
    regulation = case_when(
      padj < 0.05 & log2FoldChange >  1  ~ "Up-regulated",
      padj < 0.05 & log2FoldChange < -1  ~ "Down-regulated",
      TRUE                               ~ "Not significant"
    )
  )

write.xlsx(res_B_vs_C_df, 
          file = "./results/1_deg/DEG_B_vs_C.xlsx",
          rowNames = TRUE)
```

```{r}
alpha   <- 0.05
lfc_thr <- 1

res_df <- as.data.frame(res_B_vs_C_df) %>%
  mutate(
    padj = ifelse(is.na(padj), 1, padj),
    neglog10padj = -log10(padj),
    log2FC = log2FoldChange,
    regulation = case_when(
      padj <= alpha & log2FC >=  lfc_thr ~ "Up-regulated",
      padj <= alpha & log2FC <= -lfc_thr ~ "Down-regulated",
      TRUE                               ~ "Not significant"
    )
  )

y_cap <- quantile(res_df$neglog10padj[is.finite(res_df$neglog10padj)], 0.995, na.rm = TRUE)
res_df$neglog10padj_capped <- pmin(res_df$neglog10padj, y_cap)

palette_volcano <- c(
  "Down-regulated" = "#22577a",
  "Not significant"            = "#B0B0B0",
  "Up-regulated"   = "#8b1e3f"
)

p_volcano <- ggplot(res_df, aes(x = log2FC, y = neglog10padj_capped, color = regulation)) +
  geom_point(size = 3, alpha = 0.75) +
  geom_hline(yintercept = -log10(alpha), linewidth = 0.5, linetype = "dashed") +
  geom_vline(xintercept = c(-lfc_thr, lfc_thr), linewidth = 0.5, linetype = "dashed") +
  scale_color_manual(values = palette_volcano, name = "Regulation") +
  labs(
    x = "log2(FoldChange)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    legend.position = "right",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
p_volcano
```



```{r}
# Parameters
alpha        <- 0.05
lfc_thr      <- 1
gene_col     <- "gene_id"

dds$classification <- relevel(dds$classification, ref = "C")
dds <- DESeq(dds)
resultsNames(dds)
coef_name <- "classification_B_vs_C"
res_raw <- results(dds, name = coef_name, alpha = alpha)

# Shrunken LFCs
res_shrunk <- lfcShrink(dds, coef = coef_name, res = res_raw, type = "apeglm")

# keep p-values/padj wo shrink (res_raw) and replace log2FC for shrunken one
res_df <- as.data.frame(res_raw) %>%
  mutate(
    padj      = ifelse(is.na(padj), 1, padj),
    neglog10p = -log10(padj),
    log2FC_sh = as.numeric(res_shrunk$log2FoldChange)
  )

if (!gene_col %in% colnames(res_df)) {
  res_df[[gene_col]] <- rownames(res_df)
}

# classify using padj (raw) y |log2FC_sh|:
res_df <- res_df %>%
  mutate(
    regulation = case_when(
      padj <= alpha & log2FC_sh >=  lfc_thr ~ "Up-regulated",
      padj <= alpha & log2FC_sh <= -lfc_thr ~ "Down-regulated",
      TRUE                                  ~ "Not significant"
    )
  )

pal_fill <- c(
  "Down-regulated" = "#22577a",
  "Not significant"            = "#B0B0B0",
  "Up-regulated"   = "#8b1e3f"
)

# labels
label_df <- res_df %>%
  filter(regulation != "Not significant") %>%
  arrange(padj, desc(abs(log2FC_sh))) %>%
  filter(!is.na(.data[[gene_col]]))

# volcano plot
p_volcano <- ggplot(res_df, aes(x = log2FC_sh, y = neglog10p)) +
  geom_point(
    aes(color = regulation),
    shape = 16, size = 2.5, alpha = 0.75
  ) +
  geom_hline(yintercept = -log10(alpha), linewidth = 0.4, linetype = "dashed") +
  geom_vline(xintercept = c(-lfc_thr, lfc_thr), linewidth = 0.4, linetype = "dashed") +
  scale_color_manual(values = pal_fill, name = "Regulation") +
  labs(
    x = expression(paste("shrunken ", log[2], "(FoldChange)")),
    y = expression(paste(-log[10], "(p-adjusted)"))
  ) +
  theme_bw(base_size = 12) +
  theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.position = "right",
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    axis.ticks.length = unit(2.2, "pt"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  )

# p_volcano <- p_volcano +
#   ggrepel::geom_text_repel(
#     data = label_df,
#     aes(
#       label = .data[[gene_col]],
#       color = regulation
#     ),
#     size = 3.5,
#     max.overlaps = 30,
#     box.padding = 0.25,
#     point.padding = 0.25,
#     min.segment.length = 0,
#     segment.size = 0.25,
#     seed = 123,
#     show.legend = FALSE
#   )

p_volcano

outfile_base <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/results/1_deg/figures/VP_B_vs_C_lfcshrink"

ggsave(
  filename = paste0(outfile_base, ".png"),
  plot = p_volcano,
  width = 8, height = 6, units = "in",
  dpi = 600,
  bg = "white"
)

ggsave(
  filename = paste0(outfile_base, ".svg"),
  plot = p_volcano,
  width = 8, height = 6, units = "in",
  device = "svg", 
  bg = "transparent"
)
```


## violin plots
```{r}
genes_p1 <- c(
  "SELE","CXCL2","NFKBIA","NFKBIE","TNFAIP3",
  "CLDN5","APOLD1","NOS3","ROBO4","SOX17","SOX7",
  "ZFP36","DUSP1","ZC3H12A","IRF1","OAS1"
)

# VST
vst_mat <- assay(vst(dds, blind = FALSE))

# Genes a graficar (fila = gene en vst_mat)
genes_use <- intersect(genes_p1, rownames(vst_mat))
stopifnot(length(genes_use) > 0)

# Meta y filtro a A/B
meta <- as.data.frame(colData(dds)) |> 
  mutate(classification = as.character(classification))
keep_ab <- meta$classification %in% c("A","B")
meta_ab <- meta[keep_ab, , drop = FALSE]
vst_ab  <- vst_mat[, keep_ab, drop = FALSE]

group_ab <- factor(meta_ab$classification,
                   levels = c("A","B"),
                   labels = c("Treated", "Untreated"))

df_long <- vst_ab[genes_use, , drop = FALSE] |>
  as.data.frame() |>
  rownames_to_column("gene") |>
  pivot_longer(-gene, names_to = "sample", values_to = "expr") |>
  left_join(tibble(sample = colnames(vst_ab), group = group_ab), by = "sample")

colores <- c("Treated" = "#9e90a2",
             "Untreated" = "#b6c2d9")

violin_plots <- ggplot(df_long, aes(x = group, y = expr, fill = group)) +
  geom_violin(trim = FALSE, scale = "width", color = NA) +
  geom_boxplot(width = 0.25, outlier.shape = NA,
               color = "gray20", linewidth = 0.25) +
  facet_wrap(~ gene, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = colores) +
  labs(x = NULL, y = "VST expression") +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "white", color = NA),
    strip.text = element_text(size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 16)
  )

outdir <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/results/1_deg/figures"

ggsave(
  filename = file.path(outdir, "violin_plot_endothelium.svg"),
  plot = violin_plots,
  width = 10,
  height = 10
)

ggsave(
  filename = file.path(outdir, "violin_plot_endothelium.png"),
  plot = violin_plots,
  width = 10,
  height = 10,
  dpi = 400
)
```


# step 3 gene set enrichment analysis

## Build gene sets
use ENTREZ IDs (NCBI Gene) which align with org.Ss.eg.db

```{r}
## Map GO terms (BP) to ENTREZ IDs for pig
go2eg <- as.list(org.Ss.egGO2ALLEGS)  # GO -> ENTREZ

## Keep only BP
go_bp <- Filter(function(go) {
  if (length(go) == 0) return(FALSE)
  Ontology(names(go)[1])  # placeholder to trigger GO.db load
  TRUE
}, go2eg)  # temporary to load GO.db

## Rebuild strictly for BP using GO.db
go_all <- as.list(org.Ss.egGO2ALLEGS) # GO -> ENTREZ
go_bp_ids <- names(go_all)[AnnotationDbi::Ontology(names(go_all)) == "BP"]
pathways_GO_BP <- lapply(go_bp_ids, function(go) unique(go_all[[go]]))
names(pathways_GO_BP) <- go_bp_ids
```

## A vs B
```{r}
# res_A_vs_B_df must contain: gene_symbol (HUGO-like), log2FoldChange, padj or pvalue
stopifnot(all(c("gene_id","log2FoldChange") %in% names(res_A_vs_B_df)))
p_col <- if ("padj" %in% names(res_A_vs_B_df)) "padj" else "pvalue"
stopifnot(p_col %in% names(res_A_vs_B_df))

# 1) Map symbols -> ENTREZID
map_sym2eg <- AnnotationDbi::select(
  org.Ss.eg.db,
  keys   = unique(na.omit(res_A_vs_B_df$gene_id)),
  keytype= "SYMBOL",
  columns= "ENTREZID"
) %>%
  distinct(SYMBOL, ENTREZID) %>% 
  filter(!is.na(ENTREZID))

# 2) Build a ranked vector in ENTREZ space
rank_tbl <- res_A_vs_B_df %>%
  dplyr::select(gene_id, log2FoldChange, !!p_col) %>%
  rename(SYMBOL = gene_id, p = !!p_col) %>%
  left_join(map_sym2eg, by = "SYMBOL") %>%
  filter(!is.na(ENTREZID)) %>%
  mutate(
    p = ifelse(is.na(p) | p <= 0, 1, p),
    rank_score = sign(log2FoldChange) * -log10(p)
  ) %>%
  group_by(ENTREZID) %>%
  # collapse one-to-many symbolâEntrez by keeping the strongest signal
  reframe(rank_score = rank_score[which.max(abs(rank_score))], .groups = "drop") %>%
  arrange(desc(rank_score))

ranks <- rank_tbl$rank_score
names(ranks) <- rank_tbl$ENTREZID

valid_ids <- intersect(names(ranks), unique(unlist(c(pathways_GO_BP))))
ranks_use <- ranks[valid_ids]
```


## B vs C
```{r}
# res_B_vs_C_df must contain: gene_symbol (HUGO-like), log2FoldChange, padj or pvalue
stopifnot(all(c("gene_id","log2FoldChange") %in% names(res_B_vs_C_df)))
p_col <- if ("padj" %in% names(res_B_vs_C_df)) "padj" else "pvalue"
stopifnot(p_col %in% names(res_B_vs_C_df))

# 1) Map symbols -> ENTREZID
map_sym2eg <- AnnotationDbi::select(
  org.Ss.eg.db,
  keys   = unique(na.omit(res_B_vs_C_df$gene_id)),
  keytype= "SYMBOL",
  columns= "ENTREZID"
) %>%
  distinct(SYMBOL, ENTREZID) %>% 
  filter(!is.na(ENTREZID))

# 2) Build a ranked vector in ENTREZ space
rank_tbl <- res_B_vs_C_df %>%
  dplyr::select(gene_id, log2FoldChange, !!p_col) %>%
  rename(SYMBOL = gene_id, p = !!p_col) %>%
  left_join(map_sym2eg, by = "SYMBOL") %>%
  filter(!is.na(ENTREZID)) %>%
  mutate(
    p = ifelse(is.na(p) | p <= 0, 1, p),
    rank_score = sign(log2FoldChange) * -log10(p)
  ) %>%
  group_by(ENTREZID) %>%
  # collapse one-to-many symbolâEntrez by keeping the strongest signal
  summarise(rank_score = rank_score[which.max(abs(rank_score))], .groups = "drop") %>%
  arrange(desc(rank_score))

ranks <- rank_tbl$rank_score
names(ranks) <- rank_tbl$ENTREZID

valid_ids <- intersect(names(ranks), unique(unlist(c(pathways_GO_BP))))
ranks_use <- ranks[valid_ids]
```

## generate gsea df
```{r}

set.seed(123)

fgsea_go <- fgsea(
  pathways = pathways_GO_BP,
  stats = ranks_use,
  minSize = 10, maxSize = 500) %>%
  arrange(padj) %>%
  mutate(collection = "GO_BP")

go_names <- tibble(
  pathway = names(pathways_GO_BP),
  term = AnnotationDbi::Term(names(pathways_GO_BP))
)

fgsea_go_df <- as.data.frame(fgsea_go) %>%
  left_join(go_names, by = "pathway") %>%
  relocate(term, .after = pathway)

fgsea_go_sig <- fgsea_go_df %>%
  filter(padj < 0.05 & (NES > 1 | NES < -1))

write.xlsx(fgsea_go_df, 
          file = "./results/2_gsea/tables/GSEA_A_vs_B.xlsx")
```


## network plot
```{r}
## 1) Nodes table (add -log10FDR and readable names)
nodes <- fgsea_go_sig %>%
  transmute(
    pathway,
    NES,
    padj,
    minus_log10FDR = -log10(padj),
    size = size %||% NA_real_
  ) %>%
  distinct()

# Try to attach human-readable GO term names; fall back to GO ID
term_map <- tibble(pathway = nodes$pathway,
                   term = AnnotationDbi::Term(nodes$pathway))
nodes <- nodes %>%
  left_join(term_map, by = "pathway") %>%
  mutate(term = ifelse(is.na(term) | term == "", pathway, term))

## 2) Build pathwayâpathway edges by Jaccard overlap of member genes
# Collect member genes for selected pathways
gs_sel <- pathways_GO_BP[nodes$pathway]

# Pairwise overlaps
comb_idx <- combn(seq_along(gs_sel), 2)
edge_list <- map_dfr(seq_len(ncol(comb_idx)), function(k) {
  i <- comb_idx[1, k]; j <- comb_idx[2, k]
  gi <- unique(gs_sel[[i]]); gj <- unique(gs_sel[[j]])
  if (length(gi) == 0 || length(gj) == 0) return(NULL)
  inter <- length(intersect(gi, gj))
  uni   <- length(union(gi, gj))
  if (uni == 0) return(NULL)
  jacc  <- inter / uni
  tibble(from = names(gs_sel)[i], to = names(gs_sel)[j],
         overlap = inter, jaccard = jacc)
})

# Keep non-trivial edges (tune the threshold as needed)
jacc_threshold <- 0.10
edges <- edge_list %>%
  filter(jaccard >= jacc_threshold)
```


```{r}
# -------------------------------
# 1. Filter and prune the edges
# -------------------------------

# Keep strongest connections per node
deg_limit <- 20

edges_pruned <- dplyr::bind_rows(
  edges %>%
    dplyr::group_by(from) %>%
    dplyr::slice_max(jaccard, n = deg_limit, with_ties = FALSE),
  edges %>%
    dplyr::group_by(to) %>%
    dplyr::slice_max(jaccard, n = deg_limit, with_ties = FALSE)
) %>%
  dplyr::distinct(from, to, .keep_all = TRUE) %>%
  dplyr::arrange(desc(jaccard))

# Optional: impose a hard cap on total edges
max_edges <- 1200
if (nrow(edges_pruned) > max_edges) {
  edges_pruned <- edges_pruned %>% slice_head(n = max_edges)
}

# -------------------------------
# 2. Create the graph
# -------------------------------

g <- igraph::graph_from_data_frame(edges_pruned, vertices = nodes, directed = FALSE)

# Remove loops and duplicates, preserving attributes
g <- igraph::simplify(
  g,
  remove.multiple = TRUE,
  remove.loops = TRUE,
  edge.attr.comb = list(
    jaccard = "max",
    overlap = "sum",
    .default = "ignore"
  )
)

# Remove isolated nodes (those with no connections)
g <- igraph::delete.vertices(g, which(igraph::degree(g) == 0))

# -------------------------------
# 3. Compute layout (fixed for reproducibility)
# -------------------------------

set.seed(7)
layout_fr <- igraph::layout_with_fr(g, niter = 2000)
V(g)$x <- layout_fr[, 1]
V(g)$y <- layout_fr[, 2]

# -------------------------------
# 4. Plot (publication-ready)
# -------------------------------

# Node size reflects the number of genes in each GO term
# (assuming column 'size' = number of member genes)

p <- ggraph(g, layout = "manual", x = V(g)$x, y = V(g)$y) +
  geom_edge_link0(aes(width = jaccard),
                  colour = "grey70", alpha = 0.5, show.legend = TRUE) +
  geom_node_point(aes(size = minus_log10FDR, colour = NES)) +
  geom_node_text(aes(label = term),
                 size = 3, repel = TRUE, vjust = 0.5, hjust = 0.5) +
  scale_edge_width(range = c(0.2, 1.4), name = "Jaccard") +
  scale_size_continuous(name = "-log10(FDR)") +
  scale_color_gradient2(low = "#4a4e69", mid = "grey80",
                        high = "#9a031e", midpoint = 0, name = "NES") +
  theme_bw() +
  theme(
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14),
    axis.text    = element_blank(),
    axis.title   = element_blank(),
    axis.ticks   = element_blank(),
    panel.grid   = element_blank(),
    plot.title   = element_blank(),
    panel.border = element_blank()
  )

p
outdir <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/results/2_gsea/figures"

ggsave(
  filename = file.path(outdir, "GO_BP_network_A_vs_B.svg"),
  plot = p,
  width = 10,
  height = 8
)

ggsave(
  filename = file.path(outdir, "GO_BP_network_A_vs_B.png"),
  plot = p,
  width = 10,
  height = 8,
  dpi = 400
)
```

## heatmap

```{r}
# save 700 x 900 in
# go_id <- "GO:0001570" # vasculogenesis
# go_id    <- "GO:0048514" # blood vessel morphogenesis
go_id <- "GO:0034097" # response to cytokine


col_up   <- "#8b1e3f"
col_down <- "#22577a"
z_cap    <- 2
group_cols <- c("Treated"="gray15","Untreated"="gray60")
# --------------------------------

vst_mat <- assay(vst(dds, blind = FALSE))

entrez_set <- pathways_GO_BP[[go_id]]
sym_map <- mapIds(org.Ss.eg.db, keys=entrez_set, keytype="ENTREZID",
                  column="SYMBOL", multiVals="first") |>
  unname() |> unique() |> na.omit()

genes_use <- intersect(sym_map, rownames(vst_mat))
stopifnot(length(genes_use) > 0)

mat_all <- vst_mat[genes_use, , drop = FALSE] |>
  as.data.frame() |> rownames_to_column("SYMBOL") |>
  group_by(SYMBOL) |> summarise(across(everything(), mean), .groups="drop") |>
  column_to_rownames("SYMBOL") |> as.matrix()

meta <- as.data.frame(colData(dds))
ann <- meta |>
  mutate(classification = factor(as.character(classification),
                                 levels=c("A","B","C"),
                                 labels=c("Treated","Untreated","Control"))) |>
  transmute(sample = rownames(meta), classification)

keep_ab <- ann$classification %in% c("Treated","Untreated")
ann_ab  <- ann[keep_ab, , drop = FALSE]
mat_ab  <- mat_all[, ann_ab$sample, drop = FALSE]

grp <- droplevels(ann_ab$classification)
treated_idx   <- grp == "Treated"
untreated_idx <- grp == "Untreated"

lfc_tbl <- tibble(
  gene = rownames(mat_ab),
  mean_treated   = rowMeans(mat_ab[, treated_idx,   drop = FALSE]),
  mean_untreated = rowMeans(mat_ab[, untreated_idx, drop = FALSE])
) |>
  mutate(lfc = mean_treated - mean_untreated)

top_up   <- lfc_tbl |> slice_max(lfc, n=20, with_ties=FALSE)
top_down <- lfc_tbl |> slice_min(lfc, n=20, with_ties=FALSE)
row_order <- bind_rows(top_up, top_down) |> arrange(desc(lfc)) |> pull(gene)

mat_top <- mat_ab[row_order, , drop = FALSE]

scale_rows <- function(x) t(scale(t(x)))
mat_top_z <- scale_rows(mat_top)
mat_top_z[mat_top_z >  z_cap] <-  z_cap
mat_top_z[mat_top_z < -z_cap] <- -z_cap

group_factor <- factor(ann_ab$classification, levels=c("Treated","Untreated"))
names(group_factor) <- ann_ab$sample

top_annot <- HeatmapAnnotation(
  Group = group_factor,
  col = list(Group = group_cols),
  annotation_name_side = "left",
  annotation_name_gp = gpar(fontsize = 14, fontface = "plain"),
  annotation_legend_param = list(
    title = "Group",
    title_gp = gpar(fontsize = 14, fontface = "plain"),
    labels_gp = gpar(fontsize = 14)
  )
)

col_fun <- colorRamp2(c(-z_cap, 0, z_cap), c(col_down, "gray95", col_up))

ht <- Heatmap(
  mat_top_z,
  name = "Z-score",
  col  = col_fun,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  top_annotation = top_annot,
  show_row_names = TRUE,
  show_column_names = FALSE,
  row_names_gp = gpar(fontsize = 14),
  column_names_gp = gpar(fontsize = 14),
  heatmap_legend_param = list(
    title = "Z-score",
    title_gp = gpar(fontface = "plain", fontsize = 14),
    labels_gp = gpar(fontsize = 14)
  )
)

draw(ht)
```


## dotplot
```{r}
fgsea_go_sig$log10FDR <- -log10(fgsea_go_sig$padj)


p <- ggplot(fgsea_go_sig,
  aes(
    x    = log10FDR,
    y    = reorder(term, log10FDR),
    fill = NES,
    size = size
  )
) +
  geom_point(shape = 21, color = "black") +
  scale_size_binned(name   = "setSize", guide  = guide_legend(label = TRUE)) +
  scale_fill_gradientn(
    colors = c( "#22577a","gray95","#8b1e3f"),
    name   = "NES"
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.background = element_rect(fill = "white"),
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text       = element_text(size = 16, color = "#333333"),
    axis.text.x      = element_text(color = "gray4", size = 14),
    axis.text.y      = element_text(color = "gray4", size = 12),
    axis.title       = element_text(size = 16),
    legend.title     = element_text(size = 16),
    legend.text      = element_text(size = 14)
  ) +
  labs(
    x    = "-Log10(FDR)",
    y    = "Biological Process",
    fill = "NES",
    size = "Size"
  )


outfile_base <- "/Volumes/Carlita/carla/mirkos-lab/01-PigBrainNCC/FinalAnalysis/results/2_gsea/figures/dotplot_A_vs_B"

ggsave(
  filename = paste0(outfile_base, ".png"),
  plot = p,
  width = 10, height = 8, units = "in",
  dpi = 600,
  bg = "white"
)

ggsave(
  filename = paste0(outfile_base, ".svg"),
  plot = p,
  width = 10, height = 8, units = "in",
  device = "svg", 
  bg = "transparent"
)

```




